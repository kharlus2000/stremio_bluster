const { addonBuilder, serveHTTP } = require('stremio-addon-sdk');
const pirateBay = require('thepiratebay');

// --- Manifesto Simplificado ---
// Recurso 'stream' foi REMOVIDO. Este addon só lida com catálogos.
const manifest = {
    id: 'community.tpb.catalog.replica', // ID único para nossa réplica
    version: '1.0.0',
    name: 'TPB Catálogo (Réplica)',
    description: 'Réplica simples de um addon de catálogo do ThePirateBay.',
    resources: ['catalog'], // APENAS CATÁLOGO
    types: ['movie', 'series'],
    catalogs: [
        { type: 'movie', id: 'tpb_top_movies', name: 'TPB Top Movies' },
        { type: 'series', id: 'tpb_top_series', name: 'TPB Top Series' }
    ]
};

const builder = new addonBuilder(manifest);

// --- Lógica do Catálogo ---
// Esta parte busca os torrents mais populares para a categoria pedida.
builder.defineCatalogHandler(async ({ type, id }) => {
    console.log(`Requisição de catálogo recebida para: ${type}`);
    
    // Define a categoria de busca no TPB
    const category = type === 'movie' ? pirateBay.categories.VIDEO.MOVIES : pirateBay.categories.VIDEO.TV_SHOWS;

    try {
        // A função topTorrents() por padrão busca os mais populares.
        const results = await pirateBay.topTorrents(category);

        // Mapeia os resultados para o formato que o Stremio entende
        const metas = results.map(torrent => {
            return {
                id: `tpb:${torrent.id}`,
                type: type,
                name: torrent.name,
                posterShape: 'poster',
                // Usamos um serviço externo para tentar encontrar um poster
                poster: `https://images.metahub.space/poster/medium/${torrent.name}/img`
            };
        });
        
        console.log(`Enviando ${metas.length} itens para o catálogo ${type}.`);
        return { metas: metas };

    } catch (err) {
        console.error('Falha ao buscar torrents no The Pirate Bay:', err);
        return { metas: [] }; // Retorna uma lista vazia em caso de erro
    }
});

// --- Inicia o Servidor ---
const port = process.env.PORT || 7000;
serveHTTP(builder.getInterface(), { port: port });
console.log(`Addon de Réplica iniciado na porta ${port}`);
console.log(`URL do Manifesto: http://127.0.0.1:${port}/manifest.json`);
